<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Transportation</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
    <div class="container d-flex justify-content-center align-items-center my-5">
        <div class="col-12">
            <form id="addFreightForm" method="POST" enctype="multipart/form-data">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="title" class="form-label">Transport Title</label>
                            <input type="text" class="form-control" id="title" name="title">
                            <div class="error" id="title_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="quantity" name="quantity">
                            <div class="error" id="quantity_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="pickup_date" class="form-label">Pickup Date</label>
                            <input type="date" class="form-control" id="pickup_date" name="pickup_date">
                            <div class="error" id="pickup_date_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="delivery_date" class="form-label">Delivery Date</label>
                            <input type="date" class="form-control" id="delivery_date" name="delivery_date">
                            <div class="error" id="delivery_date_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="publishing_date" class="form-label">Publishing Date</label>
                            <input type="date" class="form-control" id="publishing_date" name="publishing_date">
                            <div class="error" id="publishing_date_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="length_cm" class="form-label">Length (cm)</label>
                            <input type="number" class="form-control" id="length_cm" name="length_cm">
                            <div class="error" id="length_cm_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="width_cm" class="form-label">Width (cm)</label>
                            <input type="number" class="form-control" id="width_cm" name="width_cm">
                            <div class="error" id="width_cm_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="height_cm" class="form-label">Height (cm)</label>
                            <input type="number" class="form-control" id="height_cm" name="height_cm">
                            <div class="error" id="height_cm_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="price" class="form-label">Price</label>
                            <input type="number" class="form-control" id="price" name="price">
                            <div class="error" id="price_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="weight_kg" class="form-label">Weight (kg)</label>
                            <input type="number" class="form-control" id="weight_kg" name="weight_kg">
                            <div class="error" id="weight_kg_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="pickup_address" class="form-label">Pickup Address</label>
                            <input type="text" class="form-control" id="pickup_address" name="pickup_address">
                            <div class="error" id="pickup_address_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="drop_address" class="form-label">Drop Address</label>
                            <input type="text" class="form-control" id="drop_address" name="drop_address">
                            <div class="error" id="drop_address_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description"></textarea>
                            <div class="error" id="description_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="image" class="form-label">Image</label>
                            <input type="file" class="form-control" id="image" name="image">
                            <div class="error" id="image_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="PickupCountry" class="form-label">Pickup Country</label>
                            <select class="form-select country" id="PickupCountry" name="PickupCountry">
                                <option>Select Country</option>
                            </select>
                            <div class="error" id="PickupCountry_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="PickupState" class="form-label">Pickup State</label>
                            <select class="form-select state" id="PickupState" name="PickupState">
                                <option>Select State</option>
                            </select>
                            <div class="error" id="PickupState_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="PickupCity" class="form-label">Pickup City</label>
                            <select class="form-select city" id="PickupCity" name="PickupCity">
                                <option>Select City</option>
                            </select>
                            <div class="error" id="PickupCity_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="DeliveryCountry" class="form-label">Delivery Country</label>
                            <select class="form-select country" id="DeliveryCountry" name="DeliveryCountry">
                                <option>Select Country</option>
                            </select>
                            <div class="error" id="DeliveryCountry_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="DeliveryState" class="form-label">Delivery State</label>
                            <select class="form-select state" id="DeliveryState" name="DeliveryState">
                                <option>Select State</option>
                            </select>
                            <div class="error" id="DeliveryState_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="DeliveryCity" class="form-label">Delivery City</label>
                            <select class="form-select city" id="DeliveryCity" name="DeliveryCity">
                                <option>Select City</option>
                            </select>
                            <div class="error" id="DeliveryCity_error"></div>
                        </div>
                    </div>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-warning text-white">Submit</button>
                </div>
            </form>
            <div id="responseMessage" class="mt-3"></div>
        </div>
    </div>

    <script>
    $(document).ready(function() {
        $('#addFreightForm').on('submit', async function(event) {
            event.preventDefault();
            var formData = new FormData(this);

            // Log form data for debugging
            for (var pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }

            // Validate form fields
            if (!validateForm()) {
                return;
            }

            try {
                const response = await fetch("/add_transportation", {
                    method: 'POST',
                    body: formData
                });

                const text = await response.text();
                console.log('Response text:', text); // Debugging statement

                try {
                    const result = JSON.parse(text);
                    console.log('Parsed response:', result); // Debugging statement
                    if (response.ok) {
                        $('#responseMessage').html('<div class="alert alert-success">' + result.msg + '</div>');
                        if (result.redirect_url) {
                            window.location.href = result.redirect_url;
                        }
                    } else {
                        $('#responseMessage').html('<div class="alert alert-danger">' + result.msg + '</div>');
                    }
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                    $('#responseMessage').html('<div class="alert alert-danger">Invalid response from server. Please try again.</div>');
                }
            } catch (error) {
                console.error('Error:', error);
                $('#responseMessage').html('<div class="alert alert-danger">An error occurred. Please try again.</div>');
            }
        });

        function validateForm() {
            var isValid = true;
            var errorMessage = '';

            // Clear previous errors
            $('.error').html('');
            $('.form-control').removeClass('is-invalid');

            // Check for empty fields
            $('#addFreightForm input, #addFreightForm select, #addFreightForm textarea').each(function() {
                if ($(this).val() === '' && $(this).attr('name') !== 'address2' && $(this).attr('name') !== 'photo') {
                    isValid = false;
                    errorMessage = 'Please fill out this field.';
                    $(this).addClass('is-invalid');
                    $('#' + $(this).attr('id') + '_error').html(errorMessage);
                }
            });

            // Validate quantity
            var quantity = $('#quantity').val();
            if (isNaN(quantity) || quantity <= 0) {
                isValid = false;
                errorMessage = 'Please enter a valid quantity.';
                $('#quantity').addClass('is-invalid');
                $('#quantity_error').html(errorMessage);
            }

            // Validate dates
            var pickup_date = $('#pickup_date').val();
            var delivery_date = $('#delivery_date').val();
            var publishing_date = $('#publishing_date').val();
            if (pickup_date === '') {
                isValid = false;
                errorMessage = 'Pickup date is required.';
                $('#pickup_date').addClass('is-invalid');
                $('#pickup_date_error').html(errorMessage);
            }
            if (delivery_date === '') {
                isValid = false;
                errorMessage = 'Delivery date is required.';
                $('#delivery_date').addClass('is-invalid');
                $('#delivery_date_error').html(errorMessage);
            }
            if (publishing_date === '') {
                isValid = false;
                errorMessage = 'Publishing date is required.';
                $('#publishing_date').addClass('is-invalid');
                $('#publishing_date_error').html(errorMessage);
            }

            // Validate dimensions
            var length_cm = $('#length_cm').val();
            var width_cm = $('#width_cm').val();
            var height_cm = $('#height_cm').val();
            if (isNaN(length_cm) || length_cm <= 0) {
                isValid = false;
                errorMessage = 'Please enter a valid length.';
                $('#length_cm').addClass('is-invalid');
                $('#length_cm_error').html(errorMessage);
            }
            if (isNaN(width_cm) || width_cm <= 0) {
                isValid = false;
                errorMessage = 'Please enter a valid width.';
                $('#width_cm').addClass('is-invalid');
                $('#width_cm_error').html(errorMessage);
            }
            if (isNaN(height_cm) || height_cm <= 0) {
                isValid = false;
                errorMessage = 'Please enter a valid height.';
                $('#height_cm').addClass('is-invalid');
                $('#height_cm_error').html(errorMessage);
            }

            // Validate price
            var price = $('#price').val();
            if (isNaN(price) || price <= 0) {
                isValid = false;
                errorMessage = 'Please enter a valid price.';
                $('#price').addClass('is-invalid');
                $('#price_error').html(errorMessage);
            }

            // Validate weight
            var weight_kg = $('#weight_kg').val();
            if (isNaN(weight_kg) || weight_kg <= 0) {
                isValid = false;
                errorMessage = 'Please enter a valid weight.';
                $('#weight_kg').addClass('is-invalid');
                $('#weight_kg_error').html(errorMessage);
            }

            // Ensure a country, state, and city are selected
            if ($('#PickupCountry').val() === 'Select Country' || $('#PickupState').val() === 'Select State' || $('#PickupCity').val() === 'Select City') {
                isValid = false;
                errorMessage = 'Please select a pickup country, state, and city.';
                $('#PickupCountry, #PickupState, #PickupCity').addClass('is-invalid');
                $('#PickupCountry_error').html(errorMessage);
            }
            if ($('#DeliveryCountry').val() === 'Select Country' || $('#DeliveryState').val() === 'Select State' || $('#DeliveryCity').val() === 'Select City') {
                isValid = false;
                errorMessage = 'Please select a delivery country, state, and city.';
                $('#DeliveryCountry, #DeliveryState, #DeliveryCity').addClass('is-invalid');
                $('#DeliveryCountry_error').html(errorMessage);
            }

            return isValid;
        }

        var config = {
            cUrl: 'https://api.countrystatecity.in/v1/countries',
            ckey: 'b0pRMkVTNUw0NEw0RGpkZVhlS29GaWg3MUFDNFZZZ0JxUHpoTURMcg==' // Replace with your actual API key
        }

        var countrySelect = document.querySelector('.country'),
            stateSelect = document.querySelector('.state'),
            citySelect = document.querySelector('.city')

        function loadCountries() {
            let apiEndPoint = config.cUrl;

            fetch(apiEndPoint, { headers: { "X-CSCAPI-KEY": config.ckey } })
                .then(response => response.json())
                .then(data => {
                    console.log("Countries:", data);  // Check the response in console
                    if (Array.isArray(data)) {
                        data.forEach(country => {
                            const option = document.createElement('option');
                            option.value = country.iso2;
                            option.textContent = country.name;
                            countrySelect.appendChild(option);
                        });
                    } else {
                        console.error('Unexpected response format for countries');
                    }
                })
                .catch(error => {
                    console.error('Error loading countries:', error);
                });

            stateSelect.disabled = true;
            citySelect.disabled = true;
            stateSelect.style.pointerEvents = 'none';
            citySelect.style.pointerEvents = 'none';
        }

        function loadStates() {
            const selectedCountryCode = countrySelect.value;
            if (!selectedCountryCode) {
                return;
            }

            stateSelect.disabled = false;
            citySelect.disabled = true;
            stateSelect.style.pointerEvents = 'auto';
            citySelect.style.pointerEvents = 'none';

            stateSelect.innerHTML = '<option value="">Select State</option>';
            citySelect.innerHTML = '<option value="">Select City</option>';

            fetch(`${config.cUrl}/${selectedCountryCode}/states`, { headers: { "X-CSCAPI-KEY": config.ckey } })
                .then(response => response.json())
                .then(data => {
                    console.log("States:", data);  // Check the response in console
                    if (Array.isArray(data)) {
                        data.forEach(state => {
                            const option = document.createElement('option');
                            option.value = state.iso2;
                            option.textContent = state.name;
                            stateSelect.appendChild(option);
                        });
                    } else {
                        console.error('Unexpected response format for states');
                    }
                })
                .catch(error => {
                    console.error('Error loading states:', error);
                });
        }

        function loadCities() {
            const selectedCountryCode = countrySelect.value;
            const selectedStateCode = stateSelect.value;

            if (!selectedCountryCode || !selectedStateCode) {
                return;
            }

            citySelect.disabled = false;
            citySelect.style.pointerEvents = 'auto';

            citySelect.innerHTML = '<option value="">Select City</option>';

            fetch(`${config.cUrl}/${selectedCountryCode}/states/${selectedStateCode}/cities`, { headers: { "X-CSCAPI-KEY": config.ckey } })
                .then(response => response.json())
                .then(data => {
                    console.log("Cities:", data);  // Check the response in console
                    if (Array.isArray(data)) {
                        data.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city.name;
                            option.textContent = city.name;
                            citySelect.appendChild(option);
                        });
                    } else {
                        console.error('Unexpected response format for cities');
                    }
                })
                .catch(error => {
                    console.error('Error loading cities:', error);
                });
        }

        window.onload = loadCountries;
    });
    </script>
</body>
</html>


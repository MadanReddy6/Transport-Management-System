{% extends 'base.html' %}

{% block title %}Index Page{% endblock %}

{% block content %}

<div class="container d-flex justify-content-center align-items-center my-5">
    <div class="col-12 col-md-6">
        <h4 class="text-center">USER REGISTRATION FORM</h4>
        <form id="registrationForm" method="POST" enctype="multipart/form-data">
            <label for="type">Register As</label>
            <select name="Registered_as" id="select" class="form-control">
                <option value="select" activate>select</option>
                <option value="Forwarder">Forwarder</option>
                <option value="Carrier">Carrier</option>
            </select>
            <div class="error" id="Registered_as_error"></div>
            <hr>
            <div>
                <div class="mb-3">
                    <label for="loginid" class="form-label">Login id</label>
                    <input type="text" class="form-control" id="Loginid" name="Loginid">
                    <div class="error" id="Loginid_error"></div>
                </div>
                <div class="mb-3 position-relative">
                    <label for="Password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="Password" name="Password">
                    <span class="eye-icon" onclick="togglePasswordVisibility('Password')">&#128065;</span>
                    <div class="error" id="Password_error"></div>
                </div>
                <div class="mb-3 position-relative">
                    <label for="confirmpassword" class="form-label">Confirm Password</label>
                    <input type="password" class="form-control" id="confirmpassword" name="confirmpassword">
                    <span class="eye-icon" onclick="togglePasswordVisibility('confirmpassword')">&#128065;</span>
                    <div class="error" id="confirmpassword_error"></div>
                </div>
                <div class="mb-3">
                    <p>Account Type</p>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="AccountType" id="company" value="Company">
                        <label class="form-check-label" for="company">
                            Company
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="AccountType" id="privatePerson" value="Private Person">
                        <label class="form-check-label" for="privatePerson">
                            Private Person
                        </label>
                    </div>
                    <div class="error" id="AccountType_error"></div>
                </div>
                <div class="mb-3">
                    <label for="name" class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="name" name="name">
                    <div class="error" id="name_error"></div>
                </div>
                <div class="mb-3">
                    <label for="Email" class="form-label">User Email</label>
                    <input type="email" class="form-control" id="Email" name="Email">
                    <div class="error" id="Email_error"></div>
                </div>
                <div class="mb-3">
                    <label for="mobilenum" class="form-label">User mobile</label>
                    <input type="text" class="form-control" id="mobilenum" name="mobilenum">
                    <div class="error" id="mobilenum_error"></div>
                </div>
            </div>
            <div>
                <div class="mb-3">
                    <label for="dob" class="form-label">User date of birth</label>
                    <input type="date" class="form-control" id="dob" name="dob">
                    <div class="error" id="dob_error"></div>
                </div>
                <div class="mb-3">
                    <label for="address1" class="form-label">User Address line1</label>
                    <input type="text" class="form-control" id="address1" name="address1">
                    <div class="error" id="address1_error"></div>
                </div>
                <div class="mb-3">
                    <label for="address2" class="form-label">User Address line2</label>
                    <input type="text" class="form-control" id="address2" name="address2">
                </div>
                <div class="form">
                    <label for="Country" class="form-label">Country</label>
                    <select class="form-select country" id="Country" name="Country" aria-label="Default select example" onchange="loadStates()">
                        <option selected>Select Country</option>
                    </select>
                    <div class="error" id="Country_error"></div>
                </div>
                <div class="form">
                    <label for="State" class="form-label">State</label>
                    <select class="form-select state" id="State" name="State" aria-label="Default select example" onchange="loadCities()">
                        <option selected>Select State</option>
                    </select>
                    <div class="error" id="State_error"></div>
                </div>
                <div class="form">
                    <label for="City" class="form-label">City</label>
                    <select class="form-select city" id="City" name="City" aria-label="Default select example">
                        <option selected>Select City</option>
                    </select>
                    <div class="error" id="City_error"></div>
                </div>
                <div class="mb-3">
                    <label for="photo" class="form-label">User photo</label>
                    <input type="file" class="form-control" id="photo" name="photo">
                </div>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-warning text-white">Submit</button>
            </div>
        </form>
        <div id="responseMessage" class="mt-3"></div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function() {
        $('#registrationForm').on('submit', async function(event) {
            event.preventDefault();
            var formData = new FormData(this);

            // Log form data for debugging
            for (var pair of formData.entries()) {
                console.log(pair[0]+ ': ' + pair[1]);
            }

            // Validate form fields
            if (!validateForm()) {
                return;
            }

            try {
                const response = await fetch("/Register", {
                    method: 'POST',
                    body: formData
                });

                const text = await response.text();
                console.log('Response text:', text); // Debugging statement

                try {
                    const result = JSON.parse(text);
                    console.log('Parsed response:', result); // Debugging statement
                    if (response.ok) {
                        $('#responseMessage').html('<div class="alert alert-success">' + result.msg + '</div>');
                        if (result.redirect_url) {
                            window.location.href = result.redirect_url;
                        }
                    } else {
                        $('#responseMessage').html('<div class="alert alert-danger">' + result.msg + '</div>');
                    }
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                    $('#responseMessage').html('<div class="alert alert-danger">Invalid response from server. Please try again.</div>');
                }
            } catch (error) {
                console.error('Error:', error);
                $('#responseMessage').html('<div class="alert alert-danger">An error occurred. Please try again.</div>');
            }
        });

        function validateForm() {
            var isValid = true;
            var errorMessage = '';

            // Clear previous errors
            $('.error').html('');
            $('.form-control').removeClass('is-invalid');

            // Check for empty fields
            $('#registrationForm input, #registrationForm select').each(function() {
                if ($(this).val() === '' && $(this).attr('name') !== 'address2' && $(this).attr('name') !== 'photo') {
                    isValid = false;
                    errorMessage = 'Please fill out this field.';
                    $(this).addClass('is-invalid');
                    $('#' + $(this).attr('id') + '_error').html(errorMessage);
                }
            });

            // Validate email format
            var email = $('#Email').val();
            var emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
            if (!emailPattern.test(email)) {
                isValid = false;
                errorMessage = 'Please enter a valid email address.';
                $('#Email').addClass('is-invalid');
                $('#Email_error').html(errorMessage);
            }

            // Validate password
            var password = $('#Password').val();
            var confirmPassword = $('#confirmpassword').val();
            var passwordPattern = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[!@#$%^&*])[A-Za-z\d!@#$%^&*]{6,}$/;
            if (password === '') {
                isValid = false;
                errorMessage = 'Password is required.';
                $('#Password').addClass('is-invalid');
                $('#Password_error').html(errorMessage);
            } else if (!passwordPattern.test(password)) {
                isValid = false;
                errorMessage = 'Password must be at least 6 characters long and contain at least one letter, one number, and one special character.';
                $('#Password').addClass('is-invalid');
                $('#Password_error').html(errorMessage);
            } else if (password !== confirmPassword) {
                isValid = false;
                errorMessage = 'Passwords do not match.';
                $('#confirmpassword').addClass('is-invalid');
                $('#confirmpassword_error').html(errorMessage);
            }

            // Validate phone number format
            var phone = $('#mobilenum').val();
            var phonePattern = /^[0-9]{10}$/;
            if (!phonePattern.test(phone)) {
                isValid = false;
                errorMessage = 'Please enter a valid 10-digit phone number.';
                $('#mobilenum').addClass('is-invalid');
                $('#mobilenum_error').html(errorMessage);
            }

            // Ensure a country, state, and city are selected
            if ($('#Country').val() === 'Select Country' || $('#State').val() === 'Select State' || $('#City').val() === 'Select City') {
                isValid = false;
                errorMessage = 'Please select a country, state, and city.';
                $('#Country, #State, #City').addClass('is-invalid');
                $('#Country_error').html(errorMessage);
            }

            return isValid;
        }
    });

    var config = {
        cUrl: 'https://api.countrystatecity.in/v1/countries',
        ckey: 'b0pRMkVTNUw0NEw0RGpkZVhlS29GaWg3MUFDNFZZZ0JxUHpoTURMcg==' // Replace with your actual API key
    }

    var countrySelect = document.querySelector('.country'),
        stateSelect = document.querySelector('.state'),
        citySelect = document.querySelector('.city')

    function loadCountries() {
        let apiEndPoint = config.cUrl;

        fetch(apiEndPoint, { headers: { "X-CSCAPI-KEY": config.ckey } })
            .then(response => response.json())
            .then(data => {
                console.log("Countries:", data);  // Check the response in console
                if (Array.isArray(data)) {
                    data.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country.iso2;
                        option.textContent = country.name;
                        countrySelect.appendChild(option);
                    });
                } else {
                    console.error('Unexpected response format for countries');
                }
            })
            .catch(error => {
                console.error('Error loading countries:', error);
            });

        stateSelect.disabled = true;
        citySelect.disabled = true;
        stateSelect.style.pointerEvents = 'none';
        citySelect.style.pointerEvents = 'none';
    }

    function loadStates() {
        const selectedCountryCode = countrySelect.value;
        if (!selectedCountryCode) {
            return;
        }

        stateSelect.disabled = false;
        citySelect.disabled = true;
        stateSelect.style.pointerEvents = 'auto';
        citySelect.style.pointerEvents = 'none';

        stateSelect.innerHTML = '<option value="">Select State</option>';
        citySelect.innerHTML = '<option value="">Select City</option>';

        fetch(`${config.cUrl}/${selectedCountryCode}/states`, { headers: { "X-CSCAPI-KEY": config.ckey } })
            .then(response => response.json())
            .then(data => {
                console.log("States:", data);  // Check the response in console
                if (Array.isArray(data)) {
                    data.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state.iso2;
                        option.textContent = state.name;
                        stateSelect.appendChild(option);
                    });
                } else {
                    console.error('Unexpected response format for states');
                }
            })
            .catch(error => {
                console.error('Error loading states:', error);
            });
    }

    function loadCities() {
        const selectedCountryCode = countrySelect.value;
        const selectedStateCode = stateSelect.value;

        if (!selectedCountryCode || !selectedStateCode) {
            return;
        }

        citySelect.disabled = false;
        citySelect.style.pointerEvents = 'auto';

        citySelect.innerHTML = '<option value="">Select City</option>';

        fetch(`${config.cUrl}/${selectedCountryCode}/states/${selectedStateCode}/cities`, { headers: { "X-CSCAPI-KEY": config.ckey } })
            .then(response => response.json())
            .then(data => {
                console.log("Cities:", data);  // Check the response in console
                if (Array.isArray(data)) {
                    data.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.name;
                        option.textContent = city.name;
                        citySelect.appendChild(option);
                    });
                } else {
                    console.error('Unexpected response format for cities');
                }
            })
            .catch(error => {
                console.error('Error loading cities:', error);
            });
    }

    function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        if (field.type === 'password') {
            field.type = 'text';
        } else {
            field.type = 'password';
        }
    }

    window.onload = loadCountries;
</script>

<style>
    .error {
        color: red;
    }
    .eye-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
    }
</style>

{% endblock %}
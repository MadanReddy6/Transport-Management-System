<!-- filepath: /d:/Madan_MITRAz/Flask/TMS Project/templates/AddTransportation.html -->
{% extends 'base.html' %}

{% block title %}Add Transportation{% endblock %}

{% block content %}

<h2 class="text-center mt-4 mb-lg-2">Add Freight</h2>
<div class="container d-flex justify-content-center align-items-center my-5">
    <div class="col-md-10 align-items-center shadow p-lg-5 p-4">
        <form id="addFreightForm" method="POST" enctype="multipart/form-data">
            <fieldset>
                <legend>Transport Details</legend>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="mb-3">
                            <label for="title" class="form-label">Transport Title</label>
                            <input type="text" class="form-control" id="title" name="title">
                            <div class="error" id="title_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="quantity" name="quantity">
                            <div class="error" id="quantity_error"></div>
                        </div>
                        
                        
                        <div class="mb-3">
                            <label for="publishing_date" class="form-label">Publishing Date</label>
                            <input type="date" class="form-control" id="publishing_date" name="publishing_date">
                            <div class="error" id="publishing_date_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="length_cm" class="form-label">Length (cm)</label>
                            <input type="number" class="form-control" id="length_cm" name="length_cm">
                            <div class="error" id="length_cm_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="width_cm" class="form-label">Width (cm)</label>
                            <input type="number" class="form-control" id="width_cm" name="width_cm">
                            <div class="error" id="width_cm_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="height_cm" class="form-label">Height (cm)</label>
                            <input type="number" class="form-control" id="height_cm" name="height_cm">
                            <div class="error" id="height_cm_error"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="price" class="form-label">Price</label>
                            <input type="number" class="form-control" id="price" name="price">
                            <div class="error" id="price_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="weight_kg" class="form-label">Weight (kg)</label>
                            <input type="number" class="form-control" id="weight_kg" name="weight_kg">
                            <div class="error" id="weight_kg_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="image" class="form-label">Image</label>
                            <input type="file" class="form-control" id="image" name="image">
                            <div class="error" id="image_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                            <div class="error" id="description_error"></div>
                        </div>
                    </div>
                </div>
            </fieldset>
            <fieldset>
                <legend>Pickup Details</legend>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="mb-3">
                            <label for="pickup_date" class="form-label">Pickup Date</label>
                            <input type="date" class="form-control" id="pickup_date" name="pickup_date">
                            <div class="error" id="pickup_date_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="pickup_address" class="form-label">Pickup Address</label>
                            <input type="text" class="form-control" id="pickup_address" name="pickup_address">
                            <div class="error" id="pickup_address_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="PickupCountry" class="form-label">Pickup Country</label>
                            <select class="form-select country" id="PickupCountry" name="PickupCountry">
                                <option value="">Select Country</option>
                            </select>
                            <div class="error" id="PickupCountry_error"></div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="mb-3">
                            <label for="PickupState" class="form-label">Pickup State</label>
                            <select class="form-select state" id="PickupState" name="PickupState">
                                <option value="">Select State</option>
                            </select>
                            <div class="error" id="PickupState_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="PickupCity" class="form-label">Pickup City</label>
                            <select class="form-select city" id="PickupCity" name="PickupCity">
                                <option value="">Select City</option>
                            </select>
                            <div class="error" id="PickupCity_error"></div>
                        </div>
                    </div>
                </div>
            </fieldset>
            <fieldset>
                <legend>Drop Details</legend>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="mb-3">
                            <label for="delivery_date" class="form-label">Delivery Date</label>
                            <input type="date" class="form-control" id="delivery_date" name="delivery_date">
                            <div class="error" id="delivery_date_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="drop_address" class="form-label">Drop Address</label>
                            <input type="text" class="form-control" id="drop_address" name="drop_address">
                            <div class="error" id="drop_address_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="DeliveryCountry" class="form-label">Delivery Country</label>
                            <select class="form-select country" id="DeliveryCountry" name="DeliveryCountry">
                                <option value="">Select Country</option>
                            </select>
                            <div class="error" id="DeliveryCountry_error"></div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="mb-3">
                            <label for="DeliveryState" class="form-label">Delivery State</label>
                            <select class="form-select state" id="DeliveryState" name="DeliveryState">
                                <option value="">Select State</option>
                            </select>
                            <div class="error" id="DeliveryState_error"></div>
                        </div>
                        <div class="mb-3">
                            <label for="DeliveryCity" class="form-label">Delivery City</label>
                            <select class="form-select city" id="DeliveryCity" name="DeliveryCity">
                                <option value="">Select City</option>
                            </select>
                            <div class="error" id="DeliveryCity_error"></div>
                        </div>
                    </div>
                </div>
            </fieldset>      <div class="d-flex justify-content-center alert-danger mt-3">
                <button type="submit" class="btn btn-warning text-white">Submit</button>
            </div>
        </form>
    </div>
</div>



<script>
    $(document).ready(function() {
        $('#addFreightForm').on('submit', async function(event) {
            event.preventDefault();
            var formData = new FormData(this);

            // Log form data for debugging
            for (var pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }

            // Validate form fields
            if (!validateForm()) {
                return;
            }

            try {
                const response = await fetch("/add_transportation", {
                    method: 'POST',
                    body: formData
                });

                const text = await response.text();
                console.log('Response text:', text); // Debugging statement

                try {
                    const result = JSON.parse(text);
                    console.log('Parsed response:', result); // Debugging statement
                    if (response.ok) {
                        $('#responseMessage').html('<div class="alert alert-success">' + result.msg + '</div>');
                        if (result.redirect_url) {
                            window.location.href = result.redirect_url;
                        }
                    } else {
                        $('#responseMessage').html('<div class="alert alert-danger">' + result.msg + '</div>');
                    }
                } catch (e) {
                    console.error('Error parsing JSON:', e);
                    $('#responseMessage').html('<div class="alert alert-danger">Invalid response from server. Please try again.</div>');
                }
            } catch (error) {
                console.error('Error:', error);
                $('#responseMessage').html('<div class="alert alert-danger">An error occurred. Please try again.</div>');
            }
        });

        function validateForm() {
            var isValid = true;
            var errorMessage = '';

            // Clear previous errors
            $('.error').html('');
            $('.form-control').removeClass('is-invalid');

            // Check for empty fields
            $('#addFreightForm input, #addFreightForm select, #addFreightForm textarea').each(function() {
                if ($(this).val() === '' && $(this).attr('name') !== 'description' && $(this).attr('name') !== 'image') {
                    isValid = false;
                    errorMessage = 'Please fill out this field.';
                    $(this).addClass('is-invalid');
                    $('#' + $(this).attr('id') + '_error').html(errorMessage);
                }
            });

            // Validate quantity
            var quantity = $('#quantity').val();
            if (isNaN(quantity) || quantity <= 0) {
                isValid = false;
                errorMessage = 'Please enter a valid quantity.';
                $('#quantity').addClass('is-invalid');
                $('#quantity_error').html(errorMessage);
            }

            // Validate dates
            var pickup_date = $('#pickup_date').val();
            var delivery_date = $('#delivery_date').val();
            var publishing_date = $('#publishing_date').val();
            var today = new Date().toISOString().split('T')[0];
            if (pickup_date === '') {
                isValid = false;
                errorMessage = 'Pickup date is required.';
                $('#pickup_date').addClass('is-invalid');
                $('#pickup_date_error').html(errorMessage);
            } else if (pickup_date < today) {
                isValid = false;
                errorMessage = 'Pickup date cannot be in the past.';
                $('#pickup_date').addClass('is-invalid');
                $('#pickup_date_error').html(errorMessage);
            }
            if (delivery_date === '') {
                isValid = false;
                errorMessage = 'Delivery date is required.';
                $('#delivery_date').addClass('is-invalid');
                $('#delivery_date_error').html(errorMessage);
            } else if (delivery_date < today) {
                isValid = false;
                errorMessage = 'Delivery date cannot be in the past.';
                $('#delivery_date').addClass('is-invalid');
                $('#delivery_date_error').html(errorMessage);
            }
            if (publishing_date === '') {
                isValid = false;
                errorMessage = 'Publishing date is required.';
                $('#publishing_date').addClass('is-invalid');
                $('#publishing_date_error').html(errorMessage);
            }

            // Validate dimensions
            var length_cm = $('#length_cm').val();
            var width_cm = $('#width_cm').val();
            var height_cm = $('#height_cm').val();
            if (isNaN(length_cm) || length_cm <= 0) {
                isValid = false;
                errorMessage = 'Please enter a valid length.';
                $('#length_cm').addClass('is-invalid');
                $('#length_cm_error').html(errorMessage);
            }
            if (isNaN(width_cm) || width_cm <= 0) {
                isValid = false;
                errorMessage = 'Please enter a valid width.';
                $('#width_cm').addClass('is-invalid');
                $('#width_cm_error').html(errorMessage);
            }
            if (isNaN(height_cm) || height_cm <= 0) {
                isValid = false;
                errorMessage = 'Please enter a valid height.';
                $('#height_cm').addClass('is-invalid');
                $('#height_cm_error').html(errorMessage);
            }

            // Validate price
            var price = $('#price').val();
            if (isNaN(price) || price <= 0) {
                isValid = false;
                errorMessage = 'Please enter a valid price.';
                $('#price').addClass('is-invalid');
                $('#price_error').html(errorMessage);
            }

            // Validate weight
            var weight_kg = $('#weight_kg').val();
            if (isNaN(weight_kg) || weight_kg <= 0) {
                isValid = false;
                errorMessage = 'Please enter a valid weight.';
                $('#weight_kg').addClass('is-invalid');
                $('#weight_kg_error').html(errorMessage);
            }

            // Validate description
            var description = $('#description').val();
            if (description === '') {
                isValid = false;
                errorMessage = 'Description is required.';
                $('#description').addClass('is-invalid');
                $('#description_error').html(errorMessage);
            } else if (description.length > 500) {
                isValid = false;
                errorMessage = 'Description cannot exceed 500 characters.';
                $('#description').addClass('is-invalid');
                $('#description_error').html(errorMessage);
            }

            // Validate image
            var image = $('#image').val();
            if (image === '') {
                isValid = false;
                errorMessage = 'Image is required.';
                $('#image').addClass('is-invalid');
                $('#image_error').html(errorMessage);
            } else {
                var allowedExtensions = /(\.jpg|\.jpeg|\.png|\.gif)$/i;
                if (!allowedExtensions.exec(image)) {
                    isValid = false;
                    errorMessage = 'Invalid file type. Only JPG, JPEG, PNG, and GIF are allowed.';
                    $('#image').addClass('is-invalid');
                    $('#image_error').html(errorMessage);
                }
            }

            return isValid;
        }

        const pickupCountrySelect = document.getElementById('PickupCountry');
        const deliveryCountrySelect = document.getElementById('DeliveryCountry');
        const fromStateSelect = document.getElementById('PickupState');
        const toStateSelect = document.getElementById('DeliveryState');
        const fromCitySelect = document.getElementById('PickupCity');
        const toCitySelect = document.getElementById('DeliveryCity');

        function loadCountries() {
            fetch('/countries')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Countries data:", data); // Debugging
                    data.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country.id;
                        option.textContent = country.name;
                        pickupCountrySelect.appendChild(option);
                        deliveryCountrySelect.appendChild(option.cloneNode(true));
                    });
                })
                .catch(error => console.error('Error loading countries:', error));
        }

        function loadStates(selectElement, countryCode) {
            fetch(`/countries/${countryCode}/states`)
                .then(response => response.json())
                .then(data => {
                    console.log("States data:", data); // Debugging
                    data.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state.id;
                        option.textContent = state.name;
                        selectElement.appendChild(option);
                    });
                    selectElement.disabled = false;
                    selectElement.style.pointerEvents = 'auto';
                })
                .catch(error => console.error('Error loading states:', error));
        }

        function loadCities(selectElement, countryCode, stateCode) {
            fetch(`/countries/${countryCode}/states/${stateCode}/cities`)
                .then(response => response.json())
                .then(data => {
                    console.log("Cities data:", data); // Debugging
                    data.forEach(city => {
                        const option = document.createElement('option');
                        option.value = city.id;
                        option.textContent = city.name;
                        selectElement.appendChild(option);
                    });
                    selectElement.disabled = false;
                    selectElement.style.pointerEvents = 'auto';
                })
                .catch(error => console.error('Error loading cities:', error));
        }

        pickupCountrySelect.addEventListener('change', () => {
            fromStateSelect.innerHTML = '<option selected>Please Select</option>';
            loadStates(fromStateSelect, pickupCountrySelect.value);
        });

        deliveryCountrySelect.addEventListener('change', () => {
            toStateSelect.innerHTML = '<option selected>Please Select</option>';
            loadStates(toStateSelect, deliveryCountrySelect.value);
        });

        fromStateSelect.addEventListener('change', () => {
            fromCitySelect.innerHTML = '<option selected>Please Select</option>';
            loadCities(fromCitySelect, pickupCountrySelect.value, fromStateSelect.value);
        });

        toStateSelect.addEventListener('change', () => {
            toCitySelect.innerHTML = '<option selected>Please Select</option>';
            loadCities(toCitySelect, deliveryCountrySelect.value, toStateSelect.value);
        });

        window.onload = loadCountries;
    });
</script>
<style>
    .error {
        color: red;
    }
</style>

{% endblock %}